{
  "aliases": [],
  "arbitrary": [
    {
      "children": [
        {
          "data": {
            "children": [
              {
                "data": {
                  "value": "Currently we don't allow executing arbitrary commands in the build process. The more common use case is to install extra dependencies."
                },
                "type": "Words"
              }
            ]
          },
          "type": "Paragraph"
        },
        {
          "data": {
            "argument": "",
            "content": "",
            "name": "contents",
            "options": [
              [
                "local",
                ""
              ],
              [
                "depth",
                "3"
              ]
            ]
          },
          "type": "BlockDirective"
        }
      ],
      "level": 0,
      "target": null,
      "title": "Allow Installation of System Packages"
    },
    {
      "children": [
        {
          "data": {
            "children": [
              {
                "data": {
                  "value": "There is a workaround when using Sphinx to run arbitrary commands, this is executing the commands inside the "
                },
                "type": "Words"
              },
              {
                "data": {
                  "value": [
                    "conf.py"
                  ]
                },
                "type": "Verbatim"
              },
              {
                "data": {
                  "value": " file. There isn't a workaround for MkDocs, but this problem is more common in Sphinx, since users need to install some extra dependencies in order to use autodoc or build Jupyter Notebooks."
                },
                "type": "Words"
              }
            ]
          },
          "type": "Paragraph"
        },
        {
          "data": {
            "children": [
              {
                "data": {
                  "value": "However, installation of some dependencies require root access, or are easier to install using "
                },
                "type": "Words"
              },
              {
                "data": {
                  "value": [
                    "apt"
                  ]
                },
                "type": "Verbatim"
              },
              {
                "data": {
                  "value": ". Most of the CI services allow to use "
                },
                "type": "Words"
              },
              {
                "data": {
                  "value": [
                    "apt"
                  ]
                },
                "type": "Verbatim"
              },
              {
                "data": {
                  "value": " or execute any command with "
                },
                "type": "Words"
              },
              {
                "data": {
                  "value": [
                    "sudo"
                  ]
                },
                "type": "Verbatim"
              },
              {
                "data": {
                  "value": ", so users are more familiar with that workflow."
                },
                "type": "Words"
              }
            ]
          },
          "type": "Paragraph"
        },
        {
          "data": {
            "children": [
              {
                "data": {
                  "value": "Some users use Conda instead of pip to install dependencies in order to avoid these problems, but not all pip users are familiar with Conda, or want to migrate to Conda just to use Read the Docs."
                },
                "type": "Words"
              }
            ]
          },
          "type": "Paragraph"
        }
      ],
      "level": 1,
      "target": null,
      "title": "Current status"
    },
    {
      "children": [
        {
          "data": {
            "children": [
              {
                "data": {
                  "value": "Builds are run in a Docker container, but the app controlling that container lives in the same server. Allowing to execute arbitrary commands with super user privileges may introduce some security issues."
                },
                "type": "Words"
              }
            ]
          },
          "type": "Paragraph"
        }
      ],
      "level": 1,
      "target": null,
      "title": "Security concerns"
    },
    {
      "children": [
        {
          "data": {
            "children": [
              {
                "data": {
                  "value": "For the previous reasons we won't allow to execute arbitrary commands with root (yet), but instead allow only to install extra packages using "
                },
                "type": "Words"
              },
              {
                "data": {
                  "value": [
                    "apt"
                  ]
                },
                "type": "Verbatim"
              },
              {
                "data": {
                  "value": "."
                },
                "type": "Words"
              }
            ]
          },
          "type": "Paragraph"
        },
        {
          "data": {
            "children": [
              {
                "data": {
                  "value": "We would expose this through the config file. Users will provide a list of packages to install, and under the hook we would run:"
                },
                "type": "Words"
              }
            ]
          },
          "type": "Paragraph"
        },
        {
          "data": {
            "children": [
              {
                "children": [
                  {
                    "data": {
                      "children": [
                        {
                          "data": {
                            "value": [
                              "apt update -y"
                            ]
                          },
                          "type": "Verbatim"
                        }
                      ]
                    },
                    "type": "Paragraph"
                  }
                ]
              },
              {
                "children": [
                  {
                    "data": {
                      "children": [
                        {
                          "data": {
                            "value": [
                              "apt install -y {packages}"
                            ]
                          },
                          "type": "Verbatim"
                        }
                      ]
                    },
                    "type": "Paragraph"
                  }
                ]
              }
            ]
          },
          "type": "BulletList"
        },
        {
          "data": {
            "children": [
              {
                "data": {
                  "value": "These commands will be run before the Python setup step and after the clone step."
                },
                "type": "Words"
              }
            ]
          },
          "type": "Paragraph"
        },
        {
          "data": {
            "children": [
              {
                "data": {
                  "children": [
                    {
                      "data": {
                        "value": "All package names must be validated to avoid injection of extra options (like "
                      },
                      "type": "Words"
                    },
                    {
                      "data": {
                        "value": [
                          "-v"
                        ]
                      },
                      "type": "Verbatim"
                    },
                    {
                      "data": {
                        "value": ")."
                      },
                      "type": "Words"
                    }
                  ]
                },
                "type": "Paragraph"
              }
            ],
            "kind": "note",
            "title": ""
          },
          "type": "Admonition"
        }
      ],
      "level": 1,
      "target": null,
      "title": "Exposing ``apt install``"
    },
    {
      "children": [
        {
          "data": {
            "children": [
              {
                "data": {
                  "value": "Currently we use "
                },
                "type": "Words"
              },
              {
                "data": {
                  "value": [
                    "docker exec"
                  ]
                },
                "type": "Verbatim"
              },
              {
                "data": {
                  "value": " to execute commands in a running container. This command also allows to pass a user which is used to run the commands ("
                },
                "type": "Words"
              },
              {
                "data": {
                  "domain": null,
                  "role": null,
                  "value": "#8058"
                },
                "type": "Directive"
              },
              {
                "data": {
                  "value": "). We can run the "
                },
                "type": "Words"
              },
              {
                "data": {
                  "value": [
                    "apt"
                  ]
                },
                "type": "Verbatim"
              },
              {
                "data": {
                  "value": " commands in our current containers using a super user momentarily."
                },
                "type": "Words"
              }
            ]
          },
          "type": "Paragraph"
        },
        {
          "data": {
            "placeholder": "target",
            "value": ".. _#8058: https://github.com/readthedocs/readthedocs.org/pull/8058"
          },
          "type": "Unimplemented"
        }
      ],
      "level": 1,
      "target": null,
      "title": "Using ``docker exec``"
    },
    {
      "children": [
        {
          "data": {
            "children": [
              {
                "data": {
                  "value": "The config file can add an additional mapping "
                },
                "type": "Words"
              },
              {
                "data": {
                  "value": [
                    "build.apt_packages"
                  ]
                },
                "type": "Verbatim"
              },
              {
                "data": {
                  "value": " to a list of packages to install."
                },
                "type": "Words"
              }
            ]
          },
          "type": "Paragraph"
        },
        {
          "data": {
            "argument": "yaml",
            "content": "version: 2\n\nbuild:\n  apt_packages:\n     - cmatrix\n     - mysql-server",
            "name": "code-block",
            "options": []
          },
          "type": "BlockDirective"
        },
        {
          "data": {
            "children": [
              {
                "data": {
                  "children": [
                    {
                      "data": {
                        "value": "Other names that were considered were:"
                      },
                      "type": "Words"
                    }
                  ]
                },
                "type": "Paragraph"
              },
              {
                "data": {
                  "children": [
                    {
                      "children": [
                        {
                          "data": {
                            "children": [
                              {
                                "data": {
                                  "value": [
                                    "build.packages"
                                  ]
                                },
                                "type": "Verbatim"
                              }
                            ]
                          },
                          "type": "Paragraph"
                        }
                      ]
                    },
                    {
                      "children": [
                        {
                          "data": {
                            "children": [
                              {
                                "data": {
                                  "value": [
                                    "build.extra_packages"
                                  ]
                                },
                                "type": "Verbatim"
                              }
                            ]
                          },
                          "type": "Paragraph"
                        }
                      ]
                    },
                    {
                      "children": [
                        {
                          "data": {
                            "children": [
                              {
                                "data": {
                                  "value": [
                                    "build.system_packages"
                                  ]
                                },
                                "type": "Verbatim"
                              }
                            ]
                          },
                          "type": "Paragraph"
                        }
                      ]
                    }
                  ]
                },
                "type": "BulletList"
              },
              {
                "data": {
                  "children": [
                    {
                      "data": {
                        "value": "These were rejected to avoid confusion with existing keys, and to be explicit about the type of package."
                      },
                      "type": "Words"
                    }
                  ]
                },
                "type": "Paragraph"
              }
            ],
            "kind": "note",
            "title": ""
          },
          "type": "Admonition"
        }
      ],
      "level": 1,
      "target": null,
      "title": "Config file"
    },
    {
      "children": [
        {
          "data": {
            "children": [
              {
                "children": [
                  {
                    "data": {
                      "children": [
                        {
                          "data": {
                            "value": "Some users may require to pass some additional flags or install from a ppa."
                          },
                          "type": "Words"
                        }
                      ]
                    },
                    "type": "Paragraph"
                  }
                ]
              },
              {
                "children": [
                  {
                    "data": {
                      "children": [
                        {
                          "data": {
                            "value": "Some packages may require some additional setup after installation."
                          },
                          "type": "Words"
                        }
                      ]
                    },
                    "type": "Paragraph"
                  }
                ]
              }
            ]
          },
          "type": "BulletList"
        }
      ],
      "level": 1,
      "target": null,
      "title": "Possible problems"
    },
    {
      "children": [
        {
          "data": {
            "children": [
              {
                "children": [
                  {
                    "data": {
                      "children": [
                        {
                          "data": {
                            "value": "We can allow to run the containers as root doing something similar to what Travis does:   They have one tool to convert the config file to a shell script ("
                          },
                          "type": "Words"
                        },
                        {
                          "data": {
                            "domain": null,
                            "role": null,
                            "value": "travis-build_"
                          },
                          "type": "Directive"
                        },
                        {
                          "data": {
                            "value": "),   and another that spins a docker container, executes that shell script and streams the logs back ("
                          },
                          "type": "Words"
                        },
                        {
                          "data": {
                            "domain": null,
                            "role": null,
                            "value": "travis-worker_"
                          },
                          "type": "Directive"
                        },
                        {
                          "data": {
                            "value": ")."
                          },
                          "type": "Words"
                        }
                      ]
                    },
                    "type": "Paragraph"
                  },
                  {
                    "data": {
                      "placeholder": "target",
                      "value": ".. _travis-build: https://github.com/travis-ci/travis-build"
                    },
                    "type": "Unimplemented"
                  },
                  {
                    "data": {
                      "placeholder": "target",
                      "value": ".. _travis-worker: https://github.com/travis-ci/worker"
                    },
                    "type": "Unimplemented"
                  }
                ]
              },
              {
                "children": [
                  {
                    "data": {
                      "children": [
                        {
                          "data": {
                            "value": "A similar solution could be implemented using "
                          },
                          "type": "Words"
                        },
                        {
                          "data": {
                            "domain": null,
                            "role": null,
                            "value": "AWS Lambda"
                          },
                          "type": "Directive"
                        },
                        {
                          "data": {
                            "value": "."
                          },
                          "type": "Words"
                        }
                      ]
                    },
                    "type": "Paragraph"
                  },
                  {
                    "data": {
                      "value": ".. NOTE: Haven't done much research around this,\n     but I remember David mentioned this a time ago."
                    },
                    "type": "Comment"
                  },
                  {
                    "data": {
                      "placeholder": "target",
                      "value": ".. _AWS Lambda: https://aws.amazon.com/lambda/"
                    },
                    "type": "Unimplemented"
                  }
                ]
              }
            ]
          },
          "type": "BulletList"
        },
        {
          "data": {
            "children": [
              {
                "data": {
                  "value": "This of course would require a large amount of work, but may be useful for the future."
                },
                "type": "Words"
              }
            ]
          },
          "type": "Paragraph"
        }
      ],
      "level": 1,
      "target": null,
      "title": "Other possible solutions"
    }
  ],
  "content": {},
  "example_section_data": {
    "children": [],
    "level": 0,
    "target": null,
    "title": null
  },
  "item_file": null,
  "item_line": null,
  "item_type": null,
  "ordered_sections": [],
  "references": null,
  "see_also": [],
  "signature": {
    "value": null
  }
}